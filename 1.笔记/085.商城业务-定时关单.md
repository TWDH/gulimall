# 085.商城业务-定时关单

![image-20210516165607442](https://raw.githubusercontent.com/TWDH/Leetcode-From-Zero/pictures/img/image-20210516165607442.png)

![image-20210516200205582](https://raw.githubusercontent.com/TWDH/Leetcode-From-Zero/pictures/img/image-20210516200205582.png)

* 库存的 RabbitMQ 中存两种消息
  1. 自己的库存工作单消息
  2. 订单释放消息

## 1. 关闭订单

* 下订单订单，把订单存入延时队列 RabbitMQ，一段时间后 TTL，如果订单状态还是 `CREATE_NEW(0,"待付款")`，就取消订单
* **问题**：定时关单后库存解锁
  * 订单卡顿，消息没有发出
  * 库存很快发出消息，解锁库存的 RabbitMQ 优先到期，查询订单是否成功支付。由于订单卡顿，订单状态为 “新建”，没有解锁成功（订单未支付，所以一段时间后 [TTL] 解锁）。所以库存不解锁，但是库存的 RabbitMQ 消费完了，订单永不解锁。
  * 解决：订单释放（解锁）后，主动发送 RabbitMQ 消息给 stock.relase.stock.queue 绑定到库存解锁服务
  * ![image-20210516213937142](https://raw.githubusercontent.com/TWDH/Leetcode-From-Zero/pictures/img/image-20210516213937142.png)
* ![image-20210516194723594](https://raw.githubusercontent.com/TWDH/Leetcode-From-Zero/pictures/img/image-20210516194723594.png)
* ![image-20210516194749628](https://raw.githubusercontent.com/TWDH/Leetcode-From-Zero/pictures/img/image-20210516194749628.png)































